<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Paradox Primitive POC âš¡</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: #020309;
      color: #D1D5DB;
      font-family: 'Courier New', monospace;
      min-height: 100vh;
      padding: 20px;
    }
    h1 { color: #00F5FF; font-size: 1.6rem; margin-bottom: 4px; }
    h2 { color: #00F5FF; font-size: 0.95rem; margin: 20px 0 10px; border-bottom: 1px solid #1a1f35; padding-bottom: 6px; }
    h3 { color: #7C3AED; font-size: 0.82rem; margin: 14px 0 6px; }
    .subtitle { color: #9CA3AF; font-size: 0.82rem; margin-bottom: 24px; }
    a { color: #00F5FF; }
    #balance-display {
      position: fixed; top: 14px; right: 14px;
      background: #0A0A1F; border: 1px solid #00F5FF;
      color: #00F5FF; padding: 8px 16px; border-radius: 8px;
      font-size: 1rem; font-weight: bold; z-index: 100;
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: default;
    }
    #balance-display.pulse {
      transform: scale(1.2);
      box-shadow: 0 0 30px #00F5FF88;
    }
    #fireworks {
      display: none; position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #7C3AED; color: white;
      padding: 24px 48px; border-radius: 14px;
      font-size: 1.4rem; font-weight: bold; z-index: 200;
      text-align: center; box-shadow: 0 0 80px #7C3AED99;
      animation: pop 0.3s ease;
    }
    @keyframes pop {
      0% { transform: translate(-50%,-50%) scale(0.4); opacity: 0; }
      100% { transform: translate(-50%,-50%) scale(1); opacity: 1; }
    }
    .grid {
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 20px;
      max-width: 1080px;
      margin: 0 auto;
    }
    @media (max-width: 720px) { .grid { grid-template-columns: 1fr; } }
    .panel {
      background: #0A0A1F;
      border: 1px solid #1a1f35;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 16px;
    }
    input, textarea, select {
      width: 100%; background: #020309;
      border: 1px solid #2a2f45; color: #D1D5DB;
      padding: 8px 10px; border-radius: 6px;
      font-family: inherit; font-size: 0.83rem;
      margin-bottom: 8px;
      word-break: break-all;
    }
    input:focus, textarea:focus { outline: none; border-color: #00F5FF; }
    textarea { height: 64px; resize: vertical; }
    input[type="password"] { letter-spacing: 2px; }
    button {
      background: #00F5FF; color: #020309;
      border: none; padding: 8px 18px;
      border-radius: 6px; cursor: pointer;
      font-family: inherit; font-weight: bold;
      font-size: 0.83rem; transition: opacity 0.15s;
      margin-bottom: 4px;
    }
    button:hover { opacity: 0.82; }
    button:disabled { opacity: 0.4; cursor: not-allowed; }
    .btn-purple { background: #7C3AED; color: white; }
    .btn-green { background: #10B981; color: white; margin-right: 8px; }
    .btn-red { background: #EF4444; color: white; }
    .btn-small { padding: 5px 12px; font-size: 0.78rem; }
    .event-card {
      background: #020309; border: 1px solid #1a1f35;
      border-radius: 8px; padding: 12px; margin-bottom: 10px;
    }
    .claim-card { border-left: 3px solid #7C3AED; }
    .resolved-card { border-left: 3px solid #10B981; opacity: 0.6; }
    .event-kind {
      color: #7C3AED; font-size: 0.68rem;
      font-weight: bold; margin-bottom: 4px; letter-spacing: 1px;
    }
    .event-content { font-size: 0.88rem; margin-bottom: 6px; }
    .event-meta { color: #9CA3AF; font-size: 0.73rem; margin-bottom: 8px; }
    .event-status { color: #F59E0B; font-size: 0.78rem; }
    .nip-badge {
      display: inline-block; background: #7C3AED22;
      color: #7C3AED; border: 1px solid #7C3AED44;
      padding: 2px 8px; border-radius: 4px;
      font-size: 0.68rem; margin-left: 8px; vertical-align: middle;
    }
    .flow-arrow {
      text-align: center; color: #7C3AED;
      font-size: 1.1rem; padding: 4px 0;
      font-weight: bold; letter-spacing: 2px;
    }
    #log {
      max-height: 200px; overflow-y: auto;
      padding-right: 4px;
    }
    #log::-webkit-scrollbar { width: 4px; }
    #log::-webkit-scrollbar-thumb { background: #2a2f45; border-radius: 4px; }
    .log-line {
      font-size: 0.75rem; padding: 3px 0;
      border-bottom: 1px solid #0d1020;
      line-height: 1.4;
    }
    .log-success { color: #10B981; }
    .log-error { color: #EF4444; }
    .log-warn { color: #F59E0B; }
    .log-info { color: #9CA3AF; }
    .status-line {
      font-size: 0.78rem; margin-top: 6px;
      min-height: 18px;
    }
    .empty { color: #9CA3AF; font-size: 0.83rem; font-style: italic; }
    .countdown {
      display: inline-block;
      color: #F59E0B; font-weight: bold;
    }
    .footer {
      text-align: center; margin-top: 30px;
      color: #9CA3AF; font-size: 0.75rem;
    }
    .toggle-label { color: #9CA3AF; font-size: 0.78rem; margin-top: 6px; }
  </style>
</head>
<body>

<div id="balance-display">User: âš¡ 0 sats<br>Agent: âš¡ 0 sats</div>
<div id="fireworks"></div>

<div style="max-width:1080px; margin:0 auto;">

  <h1>Paradox Primitive <span class="nip-badge">POC Î±</span></h1>
  <p class="subtitle">
    Kind 1069 â†’ 1070 â†’ 1071 â†’ sats Â· Real Nostr events Â· No middlemen Â· âš¡ğŸ„
  </p>

  <p style="color:#9CA3AF;font-size:0.82rem;text-align:center;margin-bottom:20px;">
    POC uses per-browser agent keys for demo â€” production agents will be fixed services with persistent pubkeys.
  </p>

  <div class="grid">

    <div>

      <div class="panel">
        <h2>âš™ï¸ Setup</h2>

        <h3>1. Your Nostr Key (Requester)</h3>
        <input id="inp-sk" type="password"
          placeholder="Hex nsec (optional â€” leave blank for demo)" />
        <button class="btn-purple" onclick="setupKeys()">Set Keys</button>
        <div id="status-keys" class="status-line" style="color:#9CA3AF">
          Auto-generating demo keyâ€¦
        </div>

        <h3>2. Lightning Wallet (NWC)</h3>
        <input id="inp-nwc" type="password"
          placeholder="nostr+walletconnect://..." />
        <button onclick="connectWallet()">Connect Wallet</button>
        <div id="status-wallet" class="status-line" style="color:#9CA3AF">
          Not connected â€” balance will simulate
        </div>
        <p style="font-size:0.72rem;color:#9CA3AF;margin-top:6px;">
          Paste your NWC URL (Alby/LNbits â†’ Developer â†’ Nostr Wallet Connect).
        </p>

        <div class="toggle-label">
          <input type="checkbox" id="simulate-mode" checked />
          Simulate mode (safe testing â€” no real sats move) âœ“
          <div style="font-size:0.75rem;color:#9CA3AF;margin-top:4px;">
            Checked = demo only (sats simulate). Unchecked = real zaps to your agent wallet.
          </div>
        </div>
      </div>

      <div class="panel">
        <h2>ğŸ“‹ Live Event Log</h2>
        <div id="log">
          <div class="log-line log-info">Paradox POC loaded ğŸ„. Set up keys to begin.</div>
        </div>
      </div>

    </div>

    <div>

      <div class="panel">
        <h2>ğŸ¯ Post a Task <span class="nip-badge">Kind 1069</span></h2>
        <textarea id="inp-task"
          placeholder="Describe the task â€” e.g. 'Take a photo proving you're at the Bitcoin conference'"></textarea>
        <label for="inp-bounty" style="font-size:0.75rem;color:#9CA3AF;margin-bottom:4px;display:block;">Bounty in sats (optional, default 21)</label>
        <input id="inp-bounty" type="number" min="0" value="21" title="Adjust bounty sats" />
        <label for="inp-exp" style="font-size:0.75rem;color:#9CA3AF;margin-bottom:4px;display:block;">Expires in hours (default 24)</label>
        <input id="inp-exp" type="number" min="1" value="24" title="Adjust expiration hours" />
        <button id="btn-post" onclick="post1069()">
          Post Kind 1069 Task âš¡
        </button>
        <div id="status-post" class="status-line"></div>
      </div>

      <div class="flow-arrow">â†“ &nbsp; AI agent detects & replies &nbsp; â†“</div>

      <div class="panel">
        <h2>ğŸ“¬ Open Tasks <span class="nip-badge">Kind 1069</span></h2>
        <div id="tasks-list">
          <p class="empty">No open tasks yet.</p>
        </div>
      </div>

      <div class="flow-arrow">â†“ &nbsp; Verify or reject the claim &nbsp; â†“</div>

      <div class="panel">
        <h2>ğŸ¤– Pending Claims <span class="nip-badge">Kind 1070</span></h2>
        <div id="claims-list">
          <p class="empty">No pending claims.</p>
        </div>
      </div>

      <div class="flow-arrow">â†“ &nbsp; On verify: 1071 + zap fires &nbsp; â†“</div>

      <div class="panel">
        <h2>âœ… Resolved <span class="nip-badge">Kind 1071</span></h2>
        <div id="resolved-list">
          <p class="empty">Nothing resolved yet ğŸ„.</p>
        </div>
      </div>

    </div>
  </div>

  <div class="footer">
    Real events on Nostr relays (damus Â· primal Â· nos.lol) &nbsp;Â·&nbsp;
    <a href="https://github.com/paradoxyou/paradox-primitive" target="_blank">GitHub</a>
    &nbsp;Â·&nbsp;
    <a href="https://paradox.you" target="_blank">Full NIP Spec</a>
    &nbsp;Â·&nbsp; Paradox Primitive Î± â€” kind numbers subject to change
  </div>

</div>

<script type="module">
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Imports
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import {
  generateSecretKey,
  getPublicKey,
  finalizeEvent
} from 'https://esm.sh/nostr-tools@2.7.2/pure';
import { SimplePool } from 'https://esm.sh/nostr-tools@2.7.2/pool';
import { hexToBytes } from 'https://esm.sh/@noble/hashes@1.4.0/utils';
import { nwc } from 'https://esm.sh/@getalby/sdk@3.9.0';

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Config
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const RELAYS = [
  'wss://relay.damus.io',
  'wss://relay.primal.net',
  'wss://nos.lol'
];
const AGENT_DELAY_MS = 3000;
const AGENT_LIGHTNING_ADDRESS = 'paradoxprimitive@lnaddress.com'; // YOUR ADDRESS HERE

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// State
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const pool = new SimplePool();
let userSk = null;
let userPk = null;
let agentSk = null;
let agentPk = null;
let nwcClient = null;
let simBalance = 50000;
let agentSimBalance = 0; // simulated agent balance rise
const openTasks = {};
const openClaims = {};
const resolved = [];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DOM helpers
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $ = id => document.getElementById(id);
const esc = s => String(s).replace(/</g,'&lt;').replace(/>/g,'&gt;');

function log(msg, type = 'info') {
  const el = $('log');
  const line = document.createElement('div');
  line.className = `log-line log-${type}`;
  line.textContent = `${new Date().toLocaleTimeString()} â€” ${msg}`;
  el.prepend(line);
}

function setBalanceDisplay(userMsats, agentMsats = agentSimBalance) {
  const userSats = Math.floor(userMsats / 1000);
  const agentSats = Math.floor(agentMsats / 1000);
  const el = $('balance-display');
  el.innerHTML = `User: âš¡ ${userSats.toLocaleString()} sats<br>Agent: âš¡ ${agentSats.toLocaleString()} sats`;
  el.classList.add('pulse');
  setTimeout(() => el.classList.remove('pulse'), 700);
}

function showFireworks() {
  const el = $('fireworks');
  el.style.display = 'block';
  el.innerHTML = 'âš¡ğŸ¤âš¡<br>PARADOX RESOLVED ğŸ„<br>âš¡ğŸ¤âš¡';
  setTimeout(() => { el.style.display = 'none'; }, 4000);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Keys (persistent agent via localStorage)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadOrCreateAgentKey() {
  const stored = localStorage.getItem('paradox_agent_sk');
  if (stored) {
    agentSk = hexToBytes(stored);
  } else {
    agentSk = generateSecretKey();
    localStorage.setItem('paradox_agent_sk', 
      Array.from(agentSk).map(b => b.toString(16).padStart(2,'0')).join(''));
  }
  agentPk = getPublicKey(agentSk);
  log(`Agent key loaded. Pubkey: ${agentPk.slice(0,16)}â€¦ (persistent)`, 'info');
}

function setupKeys() {
  const input = $('inp-sk').value.trim();
  try {
    if (input.length === 64) {
      userSk = hexToBytes(input);
    } else if (input.length === 0) {
      userSk = generateSecretKey();
    } else {
      throw new Error('Key must be 64 hex chars');
    }
    userPk = getPublicKey(userSk);
    $('status-keys').innerHTML =
      `âœ… <span style="color:#10B981">Keys ready</span><br>` +
      `<span style="font-size:0.7rem;color:#9CA3AF">` +
      `You: ${userPk.slice(0,16)}â€¦ &nbsp;Â·&nbsp; Agent: ${agentPk.slice(0,16)}â€¦` +
      `</span>`;
    log(`Keys ready. Your pubkey: ${userPk.slice(0,16)}â€¦`, 'success');
  } catch(e) {
    $('status-keys').innerHTML = `<span style="color:#EF4444">âŒ ${e.message}</span>`;
    log(e.message, 'error');
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Wallet
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function connectWallet() {
  const url = $('inp-nwc').value.trim();
  if (!url.startsWith('nostr+walletconnect://')) {
    log('NWC URL must start with nostr+walletconnect://', 'error');
    return;
  }
  $('status-wallet').textContent = 'Connectingâ€¦';
  try {
    nwcClient = new nwc.NWCClient({ nostrWalletConnectUrl: url });
    const info = await nwcClient.getBalance();
    simBalance = info.balance;
    setBalanceDisplay(simBalance);
    $('status-wallet').innerHTML =
      `<span style="color:#10B981">âœ… Connected â€” ` +
      `${Math.floor(simBalance/1000).toLocaleString()} sats</span>`;
    log(`Wallet connected. Balance: ${Math.floor(simBalance/1000)} sats`, 'success');
    sessionStorage.setItem('nwc_url', url);
  } catch(e) {
    $('status-wallet').innerHTML = `<span style="color:#EF4444">âŒ ${e.message}</span>`;
    log(`Wallet connection failed: ${e.message}`, 'error');
    nwcClient = null;
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Kind 1069 â€” Task Request
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function post1069() {
  if (!userSk) { log('Set up keys first', 'error'); return; }
  const desc = $('inp-task').value.trim();
  const bounty = parseInt($('inp-bounty').value) || 0;
  const expHrs = parseInt($('inp-exp').value) || 24;
  if (!desc) { log('Task description is required', 'error'); return; }
  const expiration = Math.floor(Date.now() / 1000) + expHrs * 3600;
  const event = finalizeEvent({
    kind: 1069,
    content: desc,
    created_at: Math.floor(Date.now() / 1000),
    tags: [
      ['t', 'paradox-poc'],
      ['amount', String(bounty * 1000), 'msats'],
      ['expiration', String(expiration)],
    ]
  }, userSk);
  $('btn-post').disabled = true;
  $('status-post').textContent = 'Publishingâ€¦ ğŸ„';
  try {
    await Promise.any(pool.publish(RELAYS, event));
    openTasks[event.id] = event;
    log(`âœ… Kind 1069 posted! ID: ${event.id.slice(0,12)}â€¦`, 'success');
    $('status-post').innerHTML =
      `<span style="color:#10B981">Published! ` +
      `<a href="https://nostr.com/e/${event.id}" target="_blank">View on nostr.com â†—</a></span>`;
    renderTasks();
    $('inp-task').value = '';
    $('inp-bounty').value = '';
    triggerAgentCountdown(event);
  } catch(e) {
    log(`Relay publish failed: ${e.message}`, 'error');
    $('status-post').innerHTML = `<span style="color:#EF4444">Failed: ${e.message}</span>`;
  } finally {
    $('btn-post').disabled = false;
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Agent countdown
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function triggerAgentCountdown(task1069) {
  log('ğŸ¤– Agent detected taskâ€¦ preparing claimâ€¦ ğŸ„', 'info');
  let secs = Math.ceil(AGENT_DELAY_MS / 1000);
  const taskCard = document.querySelector(`[data-task-id="${task1069.id}"]`);
  if (taskCard) {
    const status = taskCard.querySelector('.event-status');
    const tick = setInterval(() => {
      secs--;
      if (status) status.innerHTML =
        `ğŸ¤– Agent claiming in <span class="countdown">${secs}s</span>â€¦`;
      if (secs <= 0) clearInterval(tick);
    }, 1000);
  }
  setTimeout(() => post1070(task1069), AGENT_DELAY_MS);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Kind 1070 â€” Completion Claim
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function post1070(task1069) {
  if (!agentSk) { log('Agent key not ready', 'error'); return; }
  const proofUrl = 'https://paradoxyou.github.io/paradox-primitive/poc/proof.jpg';
  const nonce = Math.random().toString(36).slice(2, 18);
  const event = finalizeEvent({
    kind: 1070,
    content: 'Task complete. Proof attached. Resolve the paradox âš¡ğŸ„',
    created_at: Math.floor(Date.now() / 1000),
    tags: [
      ['e', task1069.id, '', 'root'],
      ['p', task1069.pubkey],
      ['proof', 'type', 'image'],
      ['proof', 'url', proofUrl'],
      ['proof', 'sha256', 'a'.repeat(64)],
      ['nonce', nonce],
      ['agent', 'model', 'paradox-agent-v0.1'],
    ]
  }, agentSk);
  try {
    await Promise.any(pool.publish(RELAYS, event));
    openClaims[event.id] = { claim: event, taskId: task1069.id };
    log(`ğŸ¤– Kind 1070 claim posted! ID: ${event.id.slice(0,12)}â€¦`, 'success');
    renderClaims();
    renderTasks();
  } catch(e) {
    log(`Agent claim failed: ${e.message}`, 'error');
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Kind 1071 â€” Acceptance + Payment
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function verify1071(claimId) {
  if (!userSk) { log('Set up keys first', 'error'); return; }
  const data = openClaims[claimId];
  if (!data) return;
  const { claim, taskId } = data;
  const task = openTasks[taskId];
  const bountyMsats = task
    ? parseInt((task.tags.find(t => t[0] === 'amount') || ['','0'])[1] || '0')
    : 0;
  const event = finalizeEvent({
    kind: 1071,
    content: 'Accepted. Proof verified. Paradox resolved. âš¡ğŸ„',
    created_at: Math.floor(Date.now() / 1000),
    tags: [
      ['e', claim.id, '', 'reply'],
      ['e', taskId, '', 'root'],
      ['p', claim.pubkey],
      ['payment', 'status', 'sent'],
    ]
  }, userSk);
  const statusEl = $('status-claim-' + claimId);
  if (statusEl) statusEl.textContent = 'Resolvingâ€¦';
  try {
    await Promise.any(pool.publish(RELAYS, event));
    log('âœ… Kind 1071 published â€” paradox resolved ğŸ„!', 'success');
    const invoiceInput = $('inp-invoice');
    const invoice = invoiceInput ? invoiceInput.value.trim() : '';
    const simulate = $('simulate-mode').checked;
    if (simulate) {
      if (bountyMsats > 0) {
        simBalance = Math.max(0, simBalance - bountyMsats);
        agentSimBalance = (agentSimBalance || 0) + bountyMsats;
        setBalanceDisplay(simBalance, agentSimBalance);
        log(`âš¡ Simulated: sent ${Math.floor(bountyMsats/1000)} sats to agent ğŸ„`, 'warn');
      }
      if (statusEl) statusEl.innerHTML = '<span style="color:#10B981">Success (simulated) ğŸ„</span>';
    } else if (nwcClient && bountyMsats > 0) {
      log(`âš¡ Sending ${Math.floor(bountyMsats/1000)} sats via NWCâ€¦`, 'info');
      try {
        let invoiceToPay = invoice;
        if (!invoiceToPay.startsWith('lnbc')) {
          log(`Fetching invoice from ${AGENT_LIGHTNING_ADDRESS}â€¦ ğŸ„`, 'info');
          const [user, domain] = AGENT_LIGHTNING_ADDRESS.split('@');
          const lnurlRes = await fetch(
            `https://${domain}/.well-known/lnurlp/${user}`
          );
          if (!lnurlRes.ok) throw new Error(`LNURL fetch failed: ${lnurlRes.status}`);
          const lnurlData = await lnurlRes.json();
          const invoiceRes = await fetch(
            `${lnurlData.callback}?amount=${bountyMsats}`
          );
          if (!invoiceRes.ok) throw new Error(`Invoice fetch failed: ${invoiceRes.status}`);
          const invoiceData = await invoiceRes.json();
          if (invoiceData.pr) {
            invoiceToPay = invoiceData.pr;
          } else {
            throw new Error('No invoice returned from LNURL');
          }
        }
        const result = await nwcClient.payInvoice({ invoice: invoiceToPay });
        // Null-safe preimage + success check
        const preimageSnippet = result.preimage ? result.preimage.slice(0,20) + 'â€¦' : '(no preimage returned)';
        log(`ğŸ’¸ Paid! Preimage: ${preimageSnippet} ğŸ„`, 'success');
        const info = await nwcClient.getBalance();
        simBalance = info.balance;
        agentSimBalance = (agentSimBalance || 0) + bountyMsats;
        setBalanceDisplay(simBalance, agentSimBalance);
        if (statusEl) statusEl.innerHTML = '<span style="color:#10B981">Paid âš¡ğŸ„</span>';
      } catch(e) {
        log(`Payment error: ${e.message}`, 'error');
        if (statusEl) statusEl.innerHTML = '<span style="color:#EF4444">Payment failed</span>';
        return;
      }
    } else {
      log('No wallet or bounty â€” payment skipped ğŸ„', 'warn');
      if (statusEl) statusEl.innerHTML = '<span style="color:#F59E0B">Skipped ğŸ„</span>';
    }
    const summary = {
      task: task?.content?.slice(0, 60) || 'Unknown task',
      sats: Math.floor(bountyMsats / 1000),
      eventId: event.id
    };
    resolved.push(summary);
    delete openTasks[taskId];
    delete openClaims[claimId];
    renderTasks();
    renderClaims();
    renderResolved();
    showFireworks();
  } catch(e) {
    log(`Failed to publish 1071: ${e.message}`, 'error');
    if (statusEl) statusEl.innerHTML = '<span style="color:#EF4444">Failed</span>';
  }
}
function reject1070(claimId) {
  delete openClaims[claimId];
  log('âŒ Claim rejected. Paradox unresolved ğŸ„ğŸ’€', 'warn');
  renderClaims();
}
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Render helpers
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTasks() {
  const el = $('tasks-list');
  const tasks = Object.values(openTasks);
  if (!tasks.length) {
    el.innerHTML = '<p class="empty">No open tasks yet.</p>'; return;
  }
  el.innerHTML = tasks.map(t => {
    const bountyMsats = parseInt((t.tags.find(x => x[0]==='amount')||['','0'])[1]);
    const sats = Math.floor(bountyMsats / 1000);
    const hasClaim = Object.values(openClaims).some(c => c.taskId === t.id);
    return `
      <div class="event-card" data-task-id="${t.id}">
        <div class="event-kind">KIND 1069 Â· TASK REQUEST</div>
        <div class="event-content">${esc(t.content)}</div>
        <div class="event-meta">
          Bounty: ${sats} sats &nbsp;Â·&nbsp;
          ID: <a href="https://nostr.com/e/${t.id}" target="_blank">${t.id.slice(0,12)}â€¦ â†—</a>
        </div>
        <div class="event-status">
          ${hasClaim ? 'ğŸ¤– Claim received â€” check below ğŸ„' : 'â³ Awaiting agent claimâ€¦'}
        </div>
      </div>`;
  }).join('');
}
function renderClaims() {
  const el = $('claims-list');
  const claims = Object.values(openClaims);
  if (!claims.length) {
    el.innerHTML = '<p class="empty">No pending claims.</p>'; return;
  }
  el.innerHTML = claims.map(({ claim, taskId }) => {
    const proofUrl = (claim.tags.find(t => t[1]==='url') || [])[2] || '';
    return `
      <div class="event-card claim-card">
        <div class="event-kind">KIND 1070 Â· COMPLETION CLAIM</div>
        <div class="event-content">${esc(claim.content)}</div>
        <div class="event-meta">
          Agent: ${claim.pubkey.slice(0,12)}â€¦ &nbsp;Â·&nbsp;
          ID: <a href="https://nostr.com/e/${claim.id}" target="_blank">${claim.id.slice(0,12)}â€¦ â†—</a>
          ${proofUrl ? `
            <div style="margin-top:8px;">
              <img src="${esc(proofUrl)}" alt="Proof Image" style="max-width:100%;border-radius:6px;border:1px solid #1a1f35;" onerror="this.onerror=null;this.src='https://via.placeholder.com/300x200/1a1f35/00F5FF?text=Proof+Failed+to+Load';" />
              <br><small><a href="${esc(proofUrl)}" target="_blank">Open full size â†—</a></small>
            </div>` : '<p style="color:#F59E0B">No proof image available ğŸ„</p>'}
        </div>
        <div id="status-claim-${claim.id}" class="status-line"></div>
        <div>
          <button class="btn-green btn-small"
            onclick="window._verify('${claim.id}')">âœ… Verify & Zap</button>
          <button class="btn-red btn-small"
            onclick="window._reject('${claim.id}')">âŒ Reject</button>
        </div>
      </div>`;
  }).join('');
}
function renderResolved() {
  const el = $('resolved-list');
  if (!resolved.length) {
    el.innerHTML = '<p class="empty">Nothing resolved yet ğŸ„.</p>'; return;
  }
  el.innerHTML = resolved.map(r => `
    <div class="event-card resolved-card">
      <div class="event-kind">KIND 1071 Â· RESOLVED âœ…</div>
      <div class="event-content">${esc(r.task)}${r.task.length >= 60 ? 'â€¦' : ''}</div>
      <div class="event-meta">
        Paid: ${r.sats} sats &nbsp;Â·&nbsp;
        <a href="https://nostr.com/e/${r.eventId}" target="_blank">View 1071 â†—</a>
      </div>
    </div>`).join('');
}
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Balance polling
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
setInterval(async () => {
  if (!nwcClient) return;
  try {
    const info = await nwcClient.getBalance();
    simBalance = info.balance;
    setBalanceDisplay(simBalance);
  } catch(_) {}
}, 60_000);
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Expose to global
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window._verify = verify1071;
window._reject = reject1070;
window.setupKeys = setupKeys;
window.connectWallet = connectWallet;
window.post1069 = post1069;
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Init
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function init() {
  const saved = sessionStorage.getItem('nwc_url');
  if (saved) $('inp-nwc').value = saved;
  loadOrCreateAgentKey();
  setupKeys();
  setBalanceDisplay(simBalance);
  renderTasks();
  renderClaims();
  renderResolved();
})();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Paradox Primitive POC âš¡</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: #020309;
      color: #D1D5DB;
      font-family: 'Courier New', monospace;
      min-height: 100vh;
      padding: 20px;
    }
    h1 { color: #00F5FF; font-size: 1.6rem; margin-bottom: 4px; }
    h2 { color: #00F5FF; font-size: 0.95rem; margin: 20px 0 10px;
         border-bottom: 1px solid #1a1f35; padding-bottom: 6px; }
    h3 { color: #7C3AED; font-size: 0.82rem; margin: 14px 0 6px; }
    .subtitle { color: #9CA3AF; font-size: 0.82rem; margin-bottom: 24px; }
    a { color: #00F5FF; }

    /* â”€â”€ Balance corner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #balance-display {
      position: fixed; top: 14px; right: 14px;
      background: #0A0A1F; border: 1px solid #00F5FF;
      color: #00F5FF; padding: 8px 16px; border-radius: 8px;
      font-size: 0.9rem; font-weight: bold; z-index: 100;
      transition: transform 0.2s, box-shadow 0.2s;
      line-height: 1.6;
    }
    #balance-display.pulse {
      transform: scale(1.12);
      box-shadow: 0 0 30px #00F5FF88;
    }

    /* â”€â”€ Fireworks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #fireworks {
      display: none; position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #7C3AED; color: white;
      padding: 24px 48px; border-radius: 14px;
      font-size: 1.4rem; font-weight: bold; z-index: 200;
      text-align: center; box-shadow: 0 0 80px #7C3AED99;
      animation: pop 0.3s ease;
    }
    @keyframes pop {
      0%   { transform: translate(-50%,-50%) scale(0.4); opacity: 0; }
      100% { transform: translate(-50%,-50%) scale(1);   opacity: 1; }
    }

    /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .grid {
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 20px;
      max-width: 1080px;
      margin: 0 auto;
    }
    @media (max-width: 720px) { .grid { grid-template-columns: 1fr; } }

    .panel {
      background: #0A0A1F;
      border: 1px solid #1a1f35;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 16px;
    }

    /* â”€â”€ Inputs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    input, textarea {
      width: 100%; background: #020309;
      border: 1px solid #2a2f45; color: #D1D5DB;
      padding: 8px 10px; border-radius: 6px;
      font-family: inherit; font-size: 0.83rem;
      margin-bottom: 8px;
    }
    input:focus, textarea:focus { outline: none; border-color: #00F5FF; }
    textarea { height: 64px; resize: vertical; }
    input[type="password"] { letter-spacing: 2px; }
    input[type="checkbox"] { width: auto; margin-right: 6px; }
    label { font-size: 0.78rem; color: #9CA3AF; display: block; margin-bottom: 4px; }

    /* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    button {
      background: #00F5FF; color: #020309;
      border: none; padding: 8px 18px;
      border-radius: 6px; cursor: pointer;
      font-family: inherit; font-weight: bold;
      font-size: 0.83rem; transition: opacity 0.15s;
      margin-bottom: 4px;
    }
    button:hover  { opacity: 0.82; }
    button:disabled { opacity: 0.35; cursor: not-allowed; background: #4a4a5a; color: #888; }
    .btn-purple { background: #7C3AED; color: white; }
    .btn-green  { background: #10B981; color: white; margin-right: 8px; }
    .btn-red    { background: #EF4444; color: white; }
    .btn-small  { padding: 5px 12px; font-size: 0.78rem; }

    /* â”€â”€ Event cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .event-card {
      background: #020309; border: 1px solid #1a1f35;
      border-radius: 8px; padding: 12px; margin-bottom: 10px;
    }
    .claim-card   { border-left: 3px solid #7C3AED; }
    .resolved-card { border-left: 3px solid #10B981; opacity: 0.65; }

    .event-kind {
      color: #7C3AED; font-size: 0.68rem;
      font-weight: bold; margin-bottom: 4px; letter-spacing: 1px;
    }
    .event-content { font-size: 0.88rem; margin-bottom: 6px; }
    .event-meta    { color: #9CA3AF; font-size: 0.73rem; margin-bottom: 8px; }
    .event-status  { color: #F59E0B; font-size: 0.78rem; }

    .nip-badge {
      display: inline-block; background: #7C3AED22;
      color: #7C3AED; border: 1px solid #7C3AED44;
      padding: 2px 8px; border-radius: 4px;
      font-size: 0.68rem; margin-left: 8px; vertical-align: middle;
    }
    .flow-arrow {
      text-align: center; color: #7C3AED;
      font-size: 1.1rem; padding: 4px 0;
      font-weight: bold; letter-spacing: 2px;
    }

    /* â”€â”€ Log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #log { max-height: 200px; overflow-y: auto; padding-right: 4px; }
    #log::-webkit-scrollbar { width: 4px; }
    #log::-webkit-scrollbar-thumb { background: #2a2f45; border-radius: 4px; }
    .log-line {
      font-size: 0.75rem; padding: 3px 0;
      border-bottom: 1px solid #0d1020; line-height: 1.4;
    }
    .log-success { color: #10B981; }
    .log-error   { color: #EF4444; }
    .log-warn    { color: #F59E0B; }
    .log-info    { color: #9CA3AF; }

    .status-line { font-size: 0.78rem; margin-top: 6px; min-height: 18px; }
    .empty { color: #9CA3AF; font-size: 0.83rem; font-style: italic; }
    .countdown { display: inline-block; color: #F59E0B; font-weight: bold; }

    /* â”€â”€ Loading overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(2, 3, 9, 0.92);
      display: flex; align-items: center; justify-content: center;
      z-index: 999; color: #00F5FF; font-size: 1.2rem;
      flex-direction: column; gap: 12px;
    }
    #loading-overlay p { color: #9CA3AF; font-size: 0.82rem; }

    .footer {
      text-align: center; margin-top: 30px;
      color: #4B5563; font-size: 0.75rem;
    }

    .simulate-box {
      background: #0d0d1a; border: 1px solid #2a2f45;
      border-radius: 6px; padding: 10px; margin-top: 10px;
    }
    .simulate-box label { color: #D1D5DB; font-size: 0.82rem; }
    .simulate-box p { color: #9CA3AF; font-size: 0.73rem; margin-top: 4px; }

    .real-pay-box {
      background: #0d1a0d; border: 1px solid #10B98144;
      border-radius: 6px; padding: 10px; margin-top: 10px;
      display: none;
    }
    .real-pay-box label { color: #10B981; }
    .real-pay-box p { color: #9CA3AF; font-size: 0.73rem; margin-top: 4px; }

    .proof-img {
      max-width: 100%; border-radius: 6px;
      border: 1px solid #1a1f35; margin-top: 8px;
    }
  </style>
</head>
<body>

<!-- Loading overlay -->
<div id="loading-overlay">
  <div>Loading Paradox POCâ€¦ ğŸ„âš¡</div>
  <p>Initialising Nostr keys and relay connectionsâ€¦</p>
</div>

<!-- Balance corner -->
<div id="balance-display">
  User: âš¡ â€” sats<br>
  Agent: âš¡ â€” sats
</div>

<!-- Fireworks -->
<div id="fireworks"></div>

<div style="max-width:1080px; margin:0 auto;">

  <h1>Paradox Primitive <span class="nip-badge">POC Î±</span></h1>
  <p class="subtitle">
    Kind 1069 â†’ 1070 â†’ 1071 â†’ sats &nbsp;Â·&nbsp;
    Real Nostr events &nbsp;Â·&nbsp; No middlemen &nbsp;Â·&nbsp; âš¡ğŸ„
  </p>
  <p style="color:#9CA3AF;font-size:0.8rem;text-align:center;margin-bottom:20px;border:1px solid #1a1f35;border-radius:6px;padding:8px;">
    Per-browser agent keys for demo â€” production agents will be persistent services.
    &nbsp;|&nbsp; <a href="https://github.com/paradoxyou/paradox-primitive" target="_blank">GitHub</a>
    &nbsp;|&nbsp; <a href="https://paradox.you" target="_blank">Full NIP Spec</a>
  </p>

  <div class="grid">

    <!-- â”€â”€ LEFT COLUMN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div>
      <div class="panel">
        <h2>âš™ï¸ Setup</h2>

        <h3>1. Your Nostr Key (Requester)</h3>
        <input id="inp-sk" type="password"
          placeholder="Hex secret key (64 chars) â€” blank = demo key" />
        <button class="btn-purple" onclick="setupKeys()">Set Keys</button>
        <div id="status-keys" class="status-line" style="color:#9CA3AF">
          Auto-generating demo keyâ€¦
        </div>

        <h3>2. Lightning Wallet (NWC)</h3>
        <input id="inp-nwc" type="password"
          placeholder="nostr+walletconnect://â€¦" />
        <button onclick="connectWallet()">Connect Wallet</button>
        <div id="status-wallet" class="status-line" style="color:#9CA3AF">
          Not connected â€” balance simulates
        </div>
        <p style="font-size:0.72rem;color:#9CA3AF;margin-top:6px;">
          Get free NWC at
          <a href="https://getalby.com" target="_blank">getalby.com</a>
          â†’ Developer â†’ Nostr Wallet Connect
        </p>

        <h3>3. Payment Mode</h3>
        <div class="simulate-box">
          <label>
            <input type="checkbox" id="simulate-mode" checked
              onchange="togglePayMode()" />
            Simulate mode (safe â€” no real sats move)
          </label>
          <p>Uncheck to enable real Lightning payments via your connected wallet.</p>
        </div>

        <div class="real-pay-box" id="real-pay-box">
          <label>âš¡ Real payment mode active</label>
          <p>
            Bounty sats will be sent automatically via LNURL to the agent
            Lightning address on Verify. Make sure wallet is connected.
          </p>
          <label style="margin-top:8px;">Optional: Paste a bolt11 invoice to pay directly</label>
          <input id="inp-invoice"
            placeholder="lnbcâ€¦ (overrides LNURL auto-fetch)" />
          <p>Leave blank to auto-fetch invoice from agent Lightning address.</p>
        </div>
      </div>

      <div class="panel">
        <h2>ğŸ“‹ Live Event Log</h2>
        <div id="log">
          <div class="log-line log-info">Paradox POC loadingâ€¦ ğŸ„</div>
        </div>
      </div>
    </div>

    <!-- â”€â”€ RIGHT COLUMN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div>

      <!-- Post 1069 -->
      <div class="panel">
        <h2>ğŸ¯ Post a Task <span class="nip-badge">Kind 1069</span></h2>
        <textarea id="inp-task"
          placeholder="Describe the task â€” e.g. 'Prove you're at the Bitcoin conference with a photo'"></textarea>
        <label for="inp-bounty">Bounty in sats (default 21)</label>
        <input id="inp-bounty" type="number" min="0" value="21" />
        <label for="inp-exp">Expires in hours (default 24)</label>
        <input id="inp-exp" type="number" min="1" value="24" />
        <button id="btn-post" disabled onclick="post1069()">
          Post Kind 1069 Task âš¡
        </button>
        <div id="status-post" class="status-line"></div>
      </div>

      <div class="flow-arrow">â†“ &nbsp; AI agent detects & claims &nbsp; â†“</div>

      <!-- Open tasks -->
      <div class="panel">
        <h2>ğŸ“¬ Open Tasks <span class="nip-badge">Kind 1069</span></h2>
        <div id="tasks-list"><p class="empty">No open tasks yet.</p></div>
      </div>

      <div class="flow-arrow">â†“ &nbsp; Verify or reject the claim &nbsp; â†“</div>

      <!-- Pending claims -->
      <div class="panel">
        <h2>ğŸ¤– Pending Claims <span class="nip-badge">Kind 1070</span></h2>
        <div id="claims-list"><p class="empty">No pending claims.</p></div>
      </div>

      <div class="flow-arrow">â†“ &nbsp; On verify: 1071 fires + sats move &nbsp; â†“</div>

      <!-- Resolved -->
      <div class="panel">
        <h2>âœ… Resolved <span class="nip-badge">Kind 1071</span></h2>
        <div id="resolved-list"><p class="empty">Nothing resolved yet ğŸ„.</p></div>
      </div>

    </div>
  </div>

  <div class="footer">
    Real events on Nostr relays (damus Â· primal Â· nos.lol) &nbsp;Â·&nbsp;
    <a href="https://github.com/paradoxyou/paradox-primitive" target="_blank">GitHub</a>
    &nbsp;Â·&nbsp;
    <a href="https://paradox.you" target="_blank">Full NIP Spec</a>
    &nbsp;Â·&nbsp; Paradox Primitive Î± â€” kind numbers subject to change
  </div>

</div><!-- /wrapper -->

<script type="module">
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Imports â€” nostr-tools v2 + Alby SDK via esm.sh CDN
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import {
  generateSecretKey,
  getPublicKey,
  finalizeEvent
} from 'https://esm.sh/nostr-tools@2.7.2/pure';
import { SimplePool } from 'https://esm.sh/nostr-tools@2.7.2/pool';
import { hexToBytes } from 'https://esm.sh/@noble/hashes@1.4.0/utils';
import { nwc } from 'https://esm.sh/@getalby/sdk@3.9.0';

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Config  â† UPDATE AGENT_LN_ADDRESS to your real Alby Lightning address
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const RELAYS = [
  'wss://relay.damus.io',
  'wss://relay.primal.net',
  'wss://nos.lol'
];
const AGENT_DELAY_MS   = 3000;
const AGENT_LN_ADDRESS = 'paradoxprimitive@lnaddress.com'; // â† SET THIS

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// State
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const pool      = new SimplePool();
let userSk      = null;
let userPk      = null;
let agentSk     = null;
let agentPk     = null;
let nwcClient   = null;
let userMsats   = 50_000;  // simulated until wallet connects
let agentMsats  = 0;
const openTasks  = {};
const openClaims = {};
const resolved   = [];
const verifying  = new Set(); // prevent double-spend on double-click

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DOM helpers
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $   = id => document.getElementById(id);
const esc = s  => String(s).replace(/</g,'&lt;').replace(/>/g,'&gt;');

function log(msg, type = 'info') {
  const el   = $('log');
  const line = document.createElement('div');
  line.className = `log-line log-${type}`;
  line.textContent = `${new Date().toLocaleTimeString()} â€” ${msg}`;
  el.prepend(line);
}

function setBalanceDisplay() {
  const uSats = Math.floor(userMsats / 1000);
  const aSats = Math.floor(agentMsats / 1000);
  const simTag = nwcClient ? '' : ' (sim)';
  $('balance-display').innerHTML =
    `User:&nbsp; âš¡ ${uSats.toLocaleString()} sats${simTag}<br>` +
    `Agent: âš¡ ${aSats.toLocaleString()} sats (sim)`;
  $('balance-display').classList.add('pulse');
  setTimeout(() => $('balance-display').classList.remove('pulse'), 700);
}

function showFireworks() {
  const el = $('fireworks');
  el.style.display = 'block';
  el.innerHTML = 'âš¡ğŸ¤âš¡<br>PARADOX RESOLVED ğŸ„<br>âš¡ğŸ¤âš¡';
  setTimeout(() => { el.style.display = 'none'; }, 4000);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Payment mode toggle
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.togglePayMode = function() {
  const sim = $('simulate-mode').checked;
  $('real-pay-box').style.display = sim ? 'none' : 'block';
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Keys â€” persistent agent key via localStorage
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadOrCreateAgentKey() {
  try {
    const stored = localStorage.getItem('paradox_agent_sk');
    if (stored && stored.length === 64) {
      agentSk = hexToBytes(stored);
    } else {
      // Generate fresh and persist
      agentSk = generateSecretKey();
      localStorage.setItem(
        'paradox_agent_sk',
        Array.from(agentSk).map(b => b.toString(16).padStart(2,'0')).join('')
      );
    }
    agentPk = getPublicKey(agentSk);
    log(`Agent key ready: ${agentPk.slice(0,16)}â€¦ (persisted in browser)`, 'info');
  } catch(e) {
    // localStorage may be blocked (private browsing on some browsers)
    log(`localStorage unavailable â€” generating session-only agent key`, 'warn');
    agentSk = generateSecretKey();
    agentPk = getPublicKey(agentSk);
  }
}

window.setupKeys = function() {
  const input = $('inp-sk').value.trim();
  try {
    if (input.length === 64) {
      userSk = hexToBytes(input);
    } else if (input.length === 0) {
      userSk = generateSecretKey();
    } else {
      throw new Error('Key must be exactly 64 hex characters');
    }
    userPk = getPublicKey(userSk);
    $('status-keys').innerHTML =
      `<span style="color:#10B981">âœ… Keys ready</span><br>` +
      `<span style="font-size:0.7rem;color:#9CA3AF">` +
      `You: ${userPk.slice(0,16)}â€¦ &nbsp;Â·&nbsp; Agent: ${agentPk.slice(0,16)}â€¦` +
      `</span>`;
    log(`Keys ready. Your pubkey: ${userPk.slice(0,16)}â€¦`, 'success');
    $('btn-post').disabled = false;
  } catch(e) {
    $('status-keys').innerHTML = `<span style="color:#EF4444">âŒ ${esc(e.message)}</span>`;
    log(e.message, 'error');
  }
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Wallet connect
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.connectWallet = async function() {
  const url = $('inp-nwc').value.trim();
  if (!url.startsWith('nostr+walletconnect://')) {
    log('NWC URL must start with nostr+walletconnect://', 'error');
    return;
  }
  $('status-wallet').textContent = 'Connectingâ€¦';
  try {
    nwcClient = new nwc.NWCClient({ nostrWalletConnectUrl: url });
    const info = await nwcClient.getBalance();
    userMsats = info.balance;
    setBalanceDisplay();
    $('status-wallet').innerHTML =
      `<span style="color:#10B981">âœ… Connected â€” ` +
      `${Math.floor(userMsats/1000).toLocaleString()} sats</span>`;
    log(`Wallet connected. Balance: ${Math.floor(userMsats/1000)} sats`, 'success');
    sessionStorage.setItem('nwc_url', url);
  } catch(e) {
    $('status-wallet').innerHTML = `<span style="color:#EF4444">âŒ ${esc(e.message)}</span>`;
    log(`Wallet connection failed: ${e.message}`, 'error');
    nwcClient = null;
  }
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Fetch invoice from Lightning address via LNURL
// Returns bolt11 string or throws
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchInvoiceFromLnAddress(lnAddress, amountMsats) {
  const [user, domain] = lnAddress.split('@');
  if (!user || !domain) throw new Error('Invalid Lightning address format');

  const ctrl    = new AbortController();
  const timeout = setTimeout(() => ctrl.abort(), 8000);

  try {
    const metaRes = await fetch(
      `https://${domain}/.well-known/lnurlp/${user}`,
      { signal: ctrl.signal }
    );
    if (!metaRes.ok) throw new Error(`LNURL metadata fetch failed: ${metaRes.status}`);
    const metaData = await metaRes.json();

    const invRes = await fetch(
      `${metaData.callback}?amount=${amountMsats}`,
      { signal: ctrl.signal }
    );
    if (!invRes.ok) throw new Error(`Invoice fetch failed: ${invRes.status}`);
    const invData = await invRes.json();

    if (!invData.pr) throw new Error('No invoice in LNURL response');
    return invData.pr;
  } finally {
    clearTimeout(timeout);
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Pay via NWC â€” handles empty preimage gracefully
// This is the KEY fix: some wallets return {"preimage":""} on success.
// The SDK throws a validation error, but the payment DID go through.
// We detect this pattern and treat it as success.
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function payWithNWC(invoice) {
  try {
    const result = await nwcClient.payInvoice({ invoice });
    const preimage = result?.preimage || '(not returned)';
    return { success: true, preimage };
  } catch(e) {
    const msg = e?.message || String(e);
    // Alby NWC returns empty preimage string on some successful payments.
    // The SDK validates and throws â€” but the sats actually moved.
    // Detect this and treat as success.
    if (
      msg.includes('preimage') &&
      (msg.includes('""') || msg.includes("''") || msg.includes('empty') || msg.includes('validation'))
    ) {
      log('âš ï¸ Wallet returned empty preimage â€” payment likely succeeded (known Alby quirk)', 'warn');
      return { success: true, preimage: '(wallet did not return preimage)' };
    }
    // Any other error is a real failure
    throw e;
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Kind 1069 â€” Task Request
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.post1069 = async function() {
  if (!userSk) { log('Set up keys first', 'error'); return; }

  const desc   = $('inp-task').value.trim();
  const bounty = parseInt($('inp-bounty').value) || 0;
  const expHrs = parseInt($('inp-exp').value)    || 24;

  if (!desc) { log('Task description is required', 'error'); return; }

  const expiration = Math.floor(Date.now() / 1000) + expHrs * 3600;

  const event = finalizeEvent({
    kind: 1069,
    content: desc,
    created_at: Math.floor(Date.now() / 1000),
    tags: [
      ['t', 'paradox-poc'],
      ['amount', String(bounty * 1000), 'msats'],
      ['expiration', String(expiration)],
    ]
  }, userSk);

  $('btn-post').disabled = true;
  $('status-post').textContent = 'Publishing to relaysâ€¦';

  try {
    await Promise.any(pool.publish(RELAYS, event));
    openTasks[event.id] = event;
    log(`âœ… Kind 1069 posted! ID: ${event.id.slice(0,12)}â€¦`, 'success');
    $('status-post').innerHTML =
      `<span style="color:#10B981">Published! ` +
      `<a href="https://nostr.com/e/${event.id}" target="_blank">View on nostr.com â†—</a></span>`;
    $('inp-task').value   = '';
    renderTasks();

    // Small delay so renderTasks() DOM is ready before countdown tries to find the card
    setTimeout(() => triggerAgentCountdown(event), 150);
  } catch(e) {
    const msg = e instanceof AggregateError
      ? 'All relays rejected â€” check your connection'
      : e.message;
    log(`Relay publish failed: ${msg}`, 'error');
    $('status-post').innerHTML = `<span style="color:#EF4444">Failed: ${esc(msg)}</span>`;
  } finally {
    $('btn-post').disabled = false;
  }
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Agent countdown + auto-claim
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function triggerAgentCountdown(task1069) {
  log('ğŸ¤– Agent detected new taskâ€¦ analysing proof requirementsâ€¦', 'info');
  let secs = Math.ceil(AGENT_DELAY_MS / 1000);

  // Poll for the card element (render may be slightly async)
  const pollCard = setInterval(() => {
    const card = document.querySelector(`[data-task-id="${task1069.id}"]`);
    if (card) {
      clearInterval(pollCard);
      const statusEl = card.querySelector('.event-status');
      const tick = setInterval(() => {
        secs--;
        if (statusEl) statusEl.innerHTML =
          `ğŸ¤– Agent claiming in <span class="countdown">${secs}s</span>â€¦`;
        if (secs <= 0) clearInterval(tick);
      }, 1000);
    }
  }, 100);

  setTimeout(() => post1070(task1069), AGENT_DELAY_MS);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Kind 1070 â€” Completion Claim (Agent)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function post1070(task1069) {
  if (!agentSk) { log('Agent key not ready', 'error'); return; }

  const proofUrl = 'https://paradoxyou.github.io/paradox-primitive/poc/proof.jpg';
  const nonce    = Math.random().toString(36).slice(2, 18);

  const event = finalizeEvent({
    kind: 1070,
    content: 'Task complete. Proof attached. Resolve the paradox âš¡ğŸ„',
    created_at: Math.floor(Date.now() / 1000),
    tags: [
      ['e', task1069.id, '', 'root'],
      ['p', task1069.pubkey],
      ['proof', 'type', 'image'],
      ['proof', 'url', proofUrl],
      ['proof', 'sha256', 'a'.repeat(64)], // placeholder hash for demo
      ['nonce', nonce],
      ['agent', 'model', 'paradox-agent-v0.1'],
    ]
  }, agentSk);

  try {
    await Promise.any(pool.publish(RELAYS, event));
    openClaims[event.id] = { claim: event, taskId: task1069.id };
    log(`ğŸ¤– Kind 1070 claim posted! ID: ${event.id.slice(0,12)}â€¦`, 'success');
    renderClaims();
    renderTasks();
  } catch(e) {
    const msg = e instanceof AggregateError ? 'All relays rejected' : e.message;
    log(`Agent claim failed: ${msg}`, 'error');
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Kind 1071 â€” Acceptance + Payment
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window._verify = async function(claimId) {
  // Prevent double-click double-spend
  if (verifying.has(claimId)) return;
  verifying.add(claimId);

  const btnEl    = document.getElementById(`btn-verify-${claimId}`);
  if (btnEl) btnEl.disabled = true;

  if (!userSk) { log('Set up keys first', 'error'); verifying.delete(claimId); return; }

  const data = openClaims[claimId];
  if (!data) { verifying.delete(claimId); return; }

  const { claim, taskId } = data;
  const task         = openTasks[taskId];
  const bountyMsats  = task
    ? parseInt((task.tags.find(t => t[0] === 'amount') || ['','0'])[1] || '0')
    : 0;
  const simulate     = $('simulate-mode').checked;

  const event = finalizeEvent({
    kind: 1071,
    content: 'Accepted. Proof verified. Paradox resolved. âš¡ğŸ„',
    created_at: Math.floor(Date.now() / 1000),
    tags: [
      ['e', claim.id, '', 'reply'],
      ['e', taskId,   '', 'root'],
      ['p', claim.pubkey],
      ['payment', 'status', 'sent'],
    ]
  }, userSk);

  const statusEl = $(`status-claim-${claimId}`);
  if (statusEl) statusEl.textContent = 'Publishing 1071â€¦';

  try {
    await Promise.any(pool.publish(RELAYS, event));
    log('âœ… Kind 1071 published â€” paradox resolved!', 'success');

    // â”€â”€ Payment branch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (simulate || bountyMsats === 0) {
      // Simulate
      if (bountyMsats > 0) {
        userMsats  = Math.max(0, userMsats - bountyMsats);
        agentMsats += bountyMsats;
        setBalanceDisplay();
        log(`âš¡ Simulated: sent ${Math.floor(bountyMsats/1000)} sats to agent ğŸ„`, 'warn');
      }
      if (statusEl) statusEl.innerHTML = '<span style="color:#10B981">âœ… Resolved (simulated) ğŸ„</span>';

    } else if (nwcClient && bountyMsats > 0) {
      // Real payment
      log(`âš¡ Sending ${Math.floor(bountyMsats/1000)} sats via Lightningâ€¦`, 'info');
      if (statusEl) statusEl.textContent = 'Fetching invoiceâ€¦';

      try {
        // Prefer manually pasted invoice; fall back to LNURL auto-fetch
        const pastedInvoice = ($('inp-invoice')?.value || '').trim();
        let invoice;

        if (pastedInvoice.startsWith('lnbc')) {
          invoice = pastedInvoice;
          log('Using manually pasted invoice', 'info');
        } else {
          log(`Fetching invoice from ${AGENT_LN_ADDRESS}â€¦`, 'info');
          if (statusEl) statusEl.textContent = 'Fetching invoiceâ€¦';
          invoice = await fetchInvoiceFromLnAddress(AGENT_LN_ADDRESS, bountyMsats);
          log('Invoice fetched â€” sending paymentâ€¦', 'info');
        }

        if (statusEl) statusEl.textContent = 'Sending paymentâ€¦';
        const { preimage } = await payWithNWC(invoice);
        log(`ğŸ’¸ Payment sent! Preimage: ${preimage.slice(0,20)}â€¦ ğŸ„`, 'success');

        // Refresh real balance
        try {
          const info = await nwcClient.getBalance();
          userMsats = info.balance;
        } catch(_) { /* balance refresh non-critical */ }

        agentMsats += bountyMsats;
        setBalanceDisplay();
        if (statusEl) statusEl.innerHTML = `<span style="color:#10B981">âš¡ Paid! ğŸ„</span>`;

      } catch(e) {
        log(`Payment error: ${e.message}`, 'error');
        if (statusEl) statusEl.innerHTML = `<span style="color:#EF4444">Payment failed: ${esc(e.message)}</span>`;
        // Don't resolve the task if payment genuinely failed
        verifying.delete(claimId);
        if (btnEl) btnEl.disabled = false;
        return;
      }

    } else {
      log('No wallet connected â€” payment skipped', 'warn');
      if (statusEl) statusEl.innerHTML = '<span style="color:#F59E0B">No wallet â€” payment skipped</span>';
    }

    // â”€â”€ Bookkeeping â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    resolved.push({
      task:    task?.content?.slice(0, 60) || 'Unknown task',
      sats:    Math.floor(bountyMsats / 1000),
      eventId: event.id
    });
    delete openTasks[taskId];
    delete openClaims[claimId];
    verifying.delete(claimId);

    renderTasks();
    renderClaims();
    renderResolved();
    showFireworks();

  } catch(e) {
    const msg = e instanceof AggregateError ? 'All relays rejected' : e.message;
    log(`Failed to publish 1071: ${msg}`, 'error');
    if (statusEl) statusEl.innerHTML = `<span style="color:#EF4444">Failed: ${esc(msg)}</span>`;
    verifying.delete(claimId);
    if (btnEl) btnEl.disabled = false;
  }
};

window._reject = function(claimId) {
  delete openClaims[claimId];
  log('âŒ Claim rejected. Paradox unresolved ğŸ„ğŸ’€', 'warn');
  renderClaims();
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Render helpers
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTasks() {
  const el    = $('tasks-list');
  const tasks = Object.values(openTasks);
  if (!tasks.length) { el.innerHTML = '<p class="empty">No open tasks yet.</p>'; return; }

  el.innerHTML = tasks.map(t => {
    const bountyMsats = parseInt((t.tags.find(x => x[0]==='amount') || ['','0'])[1]);
    const sats        = Math.floor(bountyMsats / 1000);
    const hasClaim    = Object.values(openClaims).some(c => c.taskId === t.id);
    return `
      <div class="event-card" data-task-id="${t.id}">
        <div class="event-kind">KIND 1069 Â· TASK REQUEST</div>
        <div class="event-content">${esc(t.content)}</div>
        <div class="event-meta">
          Bounty: ${sats} sats &nbsp;Â·&nbsp;
          ID: <a href="https://nostr.com/e/${t.id}" target="_blank">${t.id.slice(0,12)}â€¦ â†—</a>
        </div>
        <div class="event-status">
          ${hasClaim ? 'ğŸ¤– Claim received â€” verify below' : 'â³ Awaiting agent claimâ€¦'}
        </div>
      </div>`;
  }).join('');
}

function renderClaims() {
  const el     = $('claims-list');
  const claims = Object.values(openClaims);
  if (!claims.length) { el.innerHTML = '<p class="empty">No pending claims.</p>'; return; }

  el.innerHTML = claims.map(({ claim }) => {
    const proofUrl = (claim.tags.find(t => t[1]==='url') || [])[2] || '';
    return `
      <div class="event-card claim-card">
        <div class="event-kind">KIND 1070 Â· COMPLETION CLAIM</div>
        <div class="event-content">${esc(claim.content)}</div>
        <div class="event-meta">
          Agent: ${claim.pubkey.slice(0,12)}â€¦ &nbsp;Â·&nbsp;
          ID: <a href="https://nostr.com/e/${claim.id}" target="_blank">${claim.id.slice(0,12)}â€¦ â†—</a>
        </div>
        ${proofUrl
          ? `<img class="proof-img" src="${esc(proofUrl)}" alt="Proof"
               onerror="this.style.display='none';this.nextElementSibling.style.display='block'">
             <p style="display:none;color:#F59E0B;font-size:0.78rem;">âš ï¸ Proof image failed to load</p>
             <div style="margin-top:4px;"><small><a href="${esc(proofUrl)}" target="_blank">Open proof â†—</a></small></div>`
          : '<p style="color:#F59E0B;font-size:0.78rem;">No proof image in claim</p>'
        }
        <div id="status-claim-${claim.id}" class="status-line" style="margin:6px 0;"></div>
        <div>
          <button id="btn-verify-${claim.id}" class="btn-green btn-small"
            onclick="window._verify('${claim.id}')">âœ… Verify & Zap</button>
          <button class="btn-red btn-small"
            onclick="window._reject('${claim.id}')">âŒ Reject</button>
        </div>
      </div>`;
  }).join('');
}

function renderResolved() {
  const el = $('resolved-list');
  if (!resolved.length) { el.innerHTML = '<p class="empty">Nothing resolved yet ğŸ„.</p>'; return; }
  el.innerHTML = resolved.map(r => `
    <div class="event-card resolved-card">
      <div class="event-kind">KIND 1071 Â· RESOLVED âœ…</div>
      <div class="event-content">${esc(r.task)}${r.task.length >= 60 ? 'â€¦' : ''}</div>
      <div class="event-meta">
        Paid: ${r.sats} sats &nbsp;Â·&nbsp;
        <a href="https://nostr.com/e/${r.eventId}" target="_blank">View 1071 â†—</a>
      </div>
    </div>`).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Balance polling every 60s (silent failures â€” never crash the page)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
setInterval(async () => {
  if (!nwcClient) return;
  try {
    const info = await nwcClient.getBalance();
    userMsats = info.balance;
    setBalanceDisplay();
  } catch(_) { /* stale connection â€” ignore silently */ }
}, 60_000);

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Init
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('load', function() {
  // Restore saved NWC URL
  const savedNwc = sessionStorage.getItem('nwc_url');
  if (savedNwc) $('inp-nwc').value = savedNwc;

  // Load/create persistent agent key
  loadOrCreateAgentKey();

  // Auto-setup demo user keys (enables Post button immediately)
  setupKeys();

  // Initial renders
  setBalanceDisplay();
  renderTasks();
  renderClaims();
  renderResolved();

  // Remove loading overlay
  $('loading-overlay').style.display = 'none';
});
</script>

</body>
</html>
